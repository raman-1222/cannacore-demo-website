<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Results - Cannabis Compliance Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="results-page">
            <h1 class="results-title">COMPLIANCE RESULTS</h1>

            <div class="results-divider"></div>

            <!-- Jurisdiction Dropdown -->
            <div id="jurisdictionSelectorContainer" style="display: none; margin-bottom: 30px;">
                <label for="jurisdictionSelect" style="font-weight: 600; margin-right: 10px;">Select
                    Jurisdiction:</label>
                <select id="jurisdictionSelect"
                    style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 1rem; cursor: pointer;">
                </select>
            </div>

            <!-- Results Section -->
            <div id="resultsSection"></div>

            <!-- Download Button -->
            <button id="downloadButton" class="results-download-button">DOWNLOAD</button>
        </div>
    </div>

    <script>
        let allCompliances = null;
        let selectedJurisdiction = null;

        window.addEventListener("DOMContentLoaded", () => {
            const stored = sessionStorage.getItem("complianceResults");

            if (!stored) {
                console.log("No session data found. Redirecting.");
                window.location.href = "/";
                return;
            }

            let parsed;
            try {
                parsed = JSON.parse(stored);
            } catch (e) {
                console.error("Corrupt session data. Redirecting.");
                window.location.href = "/";
                return;
            }

            console.log("Loaded results:", parsed);
            allCompliances = parsed;

            // Render all compliance data from all jurisdictions
            if (parsed.compliance_check && parsed.compliance_check.length > 0) {
                // Populate dropdown and show it
                populateJurisdictionDropdown();
                // Default to showing all jurisdictions
                renderComplianceResults("ALL");
            } else {
                document.getElementById("resultsSection").innerHTML = "<p>No compliance data found.</p>";
            }
        });

        function populateJurisdictionDropdown() {
            const select = document.getElementById("jurisdictionSelect");
            select.innerHTML = "";

            // Add "All Jurisdictions" option
            const allOption = document.createElement("option");
            allOption.value = "ALL";
            allOption.textContent = "ALL JURISDICTIONS";
            select.appendChild(allOption);

            // Extract unique jurisdictions
            const jurisdictions = (allCompliances.compliance_check || []).map(item => item.jurisdiction);
            const uniqueJurisdictions = [...new Set(jurisdictions)];

            uniqueJurisdictions.forEach(jurisdiction => {
                const option = document.createElement("option");
                option.value = jurisdiction;
                option.textContent = jurisdiction;
                select.appendChild(option);
            });

            // Show the selector
            document.getElementById("jurisdictionSelectorContainer").style.display = "block";

            select.addEventListener("change", (e) => {
                renderComplianceResults(e.target.value);
            });
        }

        function renderComplianceResults(selectedJurisdiction) {
            const resultsSection = document.getElementById("resultsSection");
            resultsSection.innerHTML = "";

            // Group by jurisdiction
            const jurisdictionMap = {};
            (allCompliances.compliance_check || []).forEach(item => {
                if (!jurisdictionMap[item.jurisdiction]) {
                    jurisdictionMap[item.jurisdiction] = [];
                }
                jurisdictionMap[item.jurisdiction].push(item);
            });

            // Filter jurisdictions if not "ALL"
            let jurisdictionsToDisplay = Object.entries(jurisdictionMap);
            if (selectedJurisdiction !== "ALL") {
                jurisdictionsToDisplay = jurisdictionsToDisplay.filter(([jurisdiction]) => jurisdiction === selectedJurisdiction);
            }

            // Display each jurisdiction
            jurisdictionsToDisplay.forEach(([jurisdiction, complianceItems]) => {
                // Jurisdiction header
                const jurisdictionHeader = document.createElement("div");
                jurisdictionHeader.style.marginBottom = "30px";
                jurisdictionHeader.style.paddingBottom = "20px";
                jurisdictionHeader.style.borderBottom = "3px solid #007bff";
                jurisdictionHeader.innerHTML = `<h2 style="font-size: 1.8rem; color: #007bff; margin-bottom: 10px;">JURISDICTION: ${jurisdiction.toUpperCase()}</h2>`;
                resultsSection.appendChild(jurisdictionHeader);

                // Display header info (use first item for metadata)
                displayHeader(allCompliances, complianceItems[0]);

                // Display each product under this jurisdiction
                complianceItems.forEach((complianceItem, productIndex) => {
                    // Display merged product key
                    if (complianceItem.merged_product_key) {
                        const keyDiv = document.createElement("div");
                        keyDiv.style.marginBottom = "20px";
                        keyDiv.style.marginTop = productIndex > 0 ? "40px" : "0";
                        keyDiv.style.paddingTop = productIndex > 0 ? "20px" : "0";
                        keyDiv.style.borderTop = productIndex > 0 ? "2px solid #ddd" : "none";
                        const capitalizedProduct = complianceItem.merged_product_key.toUpperCase();
                        keyDiv.innerHTML = `<p style="font-size: 1.3rem; font-weight: bold; color: #333;"><strong>PRODUCT:</strong> ${capitalizedProduct}</p>`;
                        resultsSection.appendChild(keyDiv);
                    }

                    // Display Label Review
                    if (complianceItem.label && complianceItem.label.length > 0) {
                        displayLabelReview(complianceItem.label);
                    }

                    // Display COA Review
                    if (complianceItem.coa && complianceItem.coa.length > 0) {
                        displayCOAReview(complianceItem.coa);
                    }
                });
            });
        }

        function getComplianceStatus(compliantValue) {
            // Normalize compliance status to handle different formats
            let complianceStatus = "Unknown";
            let statusColor = "gray";

            // Handle boolean and string values
            const normalizedValue = String(compliantValue).toLowerCase().trim();

            if (normalizedValue === "true") {
                complianceStatus = "✓ COMPLIANT";
                statusColor = "green";
            } else if (normalizedValue === "false") {
                complianceStatus = "✗ NON-COMPLIANT";
                statusColor = "red";
            } else if (normalizedValue === "human_review" || normalizedValue === "human review") {
                complianceStatus = "⚠ HUMAN REVIEW";
                statusColor = "orange";
            }

            return { complianceStatus, statusColor };
        }

        function getRefWithHyperlink(refValue, urlValue) {
            // If object has a url field, use it
            if (urlValue) {
                return `<a href="${urlValue}" target="_blank" style="color: #007bff; text-decoration: underline;">${refValue}</a>`;
            }

            // Fallback: Map known reference patterns to URLs
            let url = null;
            if (String(refValue).includes("581.217")) {
                url = "https://www.leg.state.fl.us/Statutes/index.cfm?App_mode=Display_Statute&URL=0500-0599/0581/Sections/0581.217.html";
            } else if (String(refValue).includes("5K-4.034")) {
                url = "https://www.law.cornell.edu/regulations/florida/Fla-Admin-Code-Ann-R-5K-4-034";
            } else if (String(refValue).includes("9 NYCRR")) {
                url = "https://www.dec.ny.gov/regulations";
            } else if (String(refValue).includes("101.")) {
                url = "https://www.ecfr.gov/current/title-21/part-101";
            }

            if (url) {
                return `<a href="${url}" target="_blank" style="color: #007bff; text-decoration: underline;">${refValue}</a>`;
            }

            return refValue;
        }

        function calculateOverallComplianceStatus(complianceItem) {
            let hasNonCompliant = false;
            let hasHumanReview = false;

            // Check label items
            if (complianceItem.label && Array.isArray(complianceItem.label)) {
                complianceItem.label.forEach(item => {
                    const normalized = String(item.compliant).toLowerCase().trim();
                    if (normalized === "false") {
                        hasNonCompliant = true;
                    } else if (normalized === "human_review" || normalized === "human review") {
                        hasHumanReview = true;
                    }
                });
            }

            // Check COA items
            if (complianceItem.coa && Array.isArray(complianceItem.coa)) {
                complianceItem.coa.forEach(item => {
                    const normalized = String(item.compliant).toLowerCase().trim();
                    if (normalized === "false") {
                        hasNonCompliant = true;
                    } else if (normalized === "human_review" || normalized === "human review") {
                        hasHumanReview = true;
                    }
                });
            }

            if (hasNonCompliant) {
                return { status: "NON-COMPLIANT", color: "red" };
            } else if (hasHumanReview) {
                return { status: "HUMAN REVIEW", color: "orange" };
            } else {
                return { status: "COMPLIANT", color: "green" };
            }
        }

        function displayHeader(allCompliances, complianceItem) {
            const resultsSection = document.getElementById("resultsSection");
            const headerDiv = document.createElement("div");
            headerDiv.className = "results-category header-section";
            headerDiv.style.borderBottom = "1px solid #ddd";
            headerDiv.style.paddingBottom = "30px";
            headerDiv.style.marginBottom = "40px";

            const dateTimeDisplay = allCompliances.date && allCompliances.time
                ? `${allCompliances.date} ${allCompliances.time}`
                : allCompliances.date || allCompliances.time || "N/A";

            // Calculate overall compliance status
            const overallStatus = calculateOverallComplianceStatus(complianceItem);

            // Build output section if available
            const outputSection = allCompliances.output
                ? `<p style="font-size: 0.95rem; margin-bottom: 20px; line-height: 1.6; color: #555; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">${allCompliances.output}</p>`
                : '';

            headerDiv.innerHTML = `
                <h1 style="text-align: center; font-size: 1.8rem; margin-bottom: 30px; font-weight: bold;">Label & Packaging Review</h1>
                <div style="text-align: left;">
                    <p style="font-size: 0.95rem; margin-bottom: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Jurisdiction:</strong> ${complianceItem.jurisdiction || "N/A"}</p>
                    <p style="font-size: 0.95rem; margin-bottom: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Company Name:</strong> ${allCompliances.company_name || "N/A"}</p>
                    <p style="font-size: 0.95rem; margin-bottom: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Product Type:</strong> ${allCompliances.product_type || "N/A"}</p>
                    <p style="font-size: 0.95rem; margin-bottom: 10px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Date & Time:</strong> ${dateTimeDisplay}</p>
                    ${outputSection}
                    <p style="font-size: 0.95rem; margin-bottom: 20px; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Compliance Status:</strong> <span style="color: ${overallStatus.color}; font-weight: bold;">${overallStatus.status}</span></p>
                </div>
            `;

            resultsSection.appendChild(headerDiv);
        }

        function displayLabelReview(labelData) {
            const resultsSection = document.getElementById("resultsSection");
            const labelDiv = document.createElement("div");
            labelDiv.className = "results-category";
            labelDiv.innerHTML = `<h2>LABEL REVIEW</h2>`;

            labelData.forEach((item, index) => {
                const card = document.createElement("div");
                card.className = "results-card";

                // Determine compliance status using helper function
                const { complianceStatus, statusColor } = getComplianceStatus(item.compliant);

                // Get hyperlinked reference
                const refLink = getRefWithHyperlink(item.ref || "N/A", item.url);

                card.innerHTML = `
                    <p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>${index + 1} Ref:</strong> ${refLink}</p>
                    <p style="color:${statusColor};font-weight:bold; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">${complianceStatus}</p>
                    <p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Rule Summary:</strong> ${item.rule_summary || "None provided"}</p>
                    <p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Evidence:</strong> ${item.evidence || "None provided"}</p>
                    ${item.suggested_fix ? `<p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Suggested Fix:</strong> ${item.suggested_fix}</p>` : ""}
                `;
                labelDiv.appendChild(card);
            });

            resultsSection.appendChild(labelDiv);
        }

        function displayCOAReview(coaData) {
            const resultsSection = document.getElementById("resultsSection");
            const coaDiv = document.createElement("div");
            coaDiv.className = "results-category";
            coaDiv.innerHTML = `<h2>COA REVIEW</h2>`;

            if (coaData.length === 0) {
                coaDiv.innerHTML += "<p>No COA data available</p>";
                resultsSection.appendChild(coaDiv);
                return;
            }

            coaData.forEach((item, index) => {
                const card = document.createElement("div");
                card.className = "results-card";

                // Determine compliance status using helper function
                const { complianceStatus, statusColor } = getComplianceStatus(item.compliant);

                // Get hyperlinked reference
                const refLink = getRefWithHyperlink(item.ref || "N/A", item.url);

                card.innerHTML = `
                    <p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>${index + 1} Ref:</strong> ${refLink}</p>
                    <p style="color:${statusColor};font-weight:bold; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">${complianceStatus}</p>
                    <p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Rule Summary:</strong> ${item.rule_summary || "None provided"}</p>
                    <p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Evidence:</strong> ${item.evidence || "None provided"}</p>
                    ${item.suggested_fix ? `<p style="color:black; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;"><strong>Suggested Fix:</strong> ${item.suggested_fix}</p>` : ""}
                `;
                coaDiv.appendChild(card);
            });

            resultsSection.appendChild(coaDiv);
        }

        document.getElementById("downloadButton").addEventListener("click", async () => {
            const resultsSection = document.getElementById("resultsSection");
            const downloadButton = document.getElementById("downloadButton");

            // Disable button during download
            downloadButton.disabled = true;
            downloadButton.textContent = "GENERATING WORD DOC...";

            try {
                const content = resultsSection.innerText || resultsSection.textContent;

                const response = await fetch('/api/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate document');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                a.download = `compliance-report-${timestamp}.docx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error generating Word document:', error);
                alert('Error generating Word document. Please try again.');
            } finally {
                // Re-enable button
                downloadButton.disabled = false;
                downloadButton.textContent = "DOWNLOAD";
            }
        });
        });
    </script>

</body>

</html>